<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://m.media-amazon.com/images/I/71Hyp05ySsL._AC_UF1000,1000_QL80_.jpg">
    <link rel="icon" type="image/png" href="https://m.media-amazon.com/images/I/71Hyp05ySsL._AC_UF1000,1000_QL80_.jpg">
    <title>El recetario de Mario y Esther</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; overflow-x: hidden; }
        .layout { display: block; max-width: 1400px; margin: auto; padding-top: 60px; }

        .sidebar { 
            width: 300px; position: fixed; top: 0; left: 0;
            transform: translateX(-320px); height: 100%; z-index: 1000; 
            transition: transform 0.3s ease; overflow-y: auto;
            background: #f0f2f5; padding: 80px 10px 20px 10px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar.active { transform: translateX(0); }

        .panel-lateral { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 25px; }
        .seccion-lateral h3 { margin: 0 0 15px 0; font-size: 1.1em; color: #d35400; display: flex; align-items: center; gap: 8px; }
        
        #bloc-notas { width: 100%; height: 120px; border: none; background: #fff9e6; padding: 10px; border-radius: 8px; font-family: inherit; resize: none; box-sizing: border-box; }

        h1 { color: #d35400; text-align: center; margin-top: 0; }
        .formulario, .filtros-seccion { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .fila { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .fila > * { flex: 1; min-width: 200px; }
        input, select { border: 1px solid #ddd; border-radius: 6px; padding: 12px; width: 100%; box-sizing: border-box; }
        
        button { background-color: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 6px; padding: 12px; transition: 0.3s; }
        button:hover { background-color: #219150; }

        .galeria { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .tarjeta { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; flex-direction: column; position: relative; }
        .tarjeta img { width: 100%; height: 180px; object-fit: cover; }
        
        .fav-btn { position: absolute; top: 10px; right: 10px; background: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 18px; z-index: 10; }

        .info { padding: 15px; flex-grow: 1; }
        .tag { font-size: 0.7em; color: white; padding: 4px 10px; border-radius: 20px; margin-right: 5px; display: inline-block; margin-top: 5px; font-weight: bold; }
        .tag-ing { background: #e67e22; } .tag-ela { background: #8e44ad; } .tag-tip { background: #2980b9; }

        .acciones { display: flex; border-top: 1px solid #eee; }
        .acciones button { flex: 1; border-radius: 0; padding: 10px; font-size: 0.8em; }
        .edit { background: #f39c12; } .del { background: #c0392b; }

        /* Chat Estilo Original */
        #chat-container { position: fixed; bottom: 0; right: 0; width: 50vw; height: 100vh; background: white; box-shadow: -5px 0 30px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 10000; border-left: 2px solid #d35400; }
        #chat-btn-open { position: fixed; bottom: 25px; right: 25px; background: #d35400; color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); z-index: 10001; display: flex; align-items: center; justify-content: center; }
        #chat-header { background-color: #d35400; color: white; padding: 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 12px 18px; border-radius: 12px; max-width: 85%; font-size: 1.05em; line-height: 1.6; }
        .user-msg { background: #e1f5fe; align-self: flex-end; }
        .bot-msg { background: #f8f9fa; align-self: flex-start; border-left: 4px solid #d35400; }

        @media (max-width: 900px) { #chat-container { width: 100vw; } .galeria { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<button id="menu-toggle" onclick="toggleSidebar()" style="position: fixed; top: 20px; left: 20px; z-index: 1001; background: #d35400; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 20px;">‚ò∞</button>

<div class="layout">
    <aside class="sidebar">
        <div class="panel-lateral">
            <div class="seccion-lateral">
                <h3>üîç Filtros</h3>
                <select id="sIng" onchange="sincronizarFiltros('sIng')">
                    <option value="Todos">Ingredientes</option>
                    <option value="Pollo">Pollo</option><option value="Pulpo">Pulpo</option>
                    <option value="Pescado">Pescado</option><option value="Verduras">Verduras</option>
                    <option value="Legumbres">Legumbres</option><option value="Carne">Carne</option>
                </select>
                <select id="sEla" onchange="sincronizarFiltros('sEla')">
                    <option value="Todas">Elaboraci√≥n</option>
                    <option value="Horno">Horno</option><option value="Airfryer">Airfryer</option>
                    <option value="Plancha">Plancha</option>
                </select>
                <select id="sTip" onchange="sincronizarFiltros('sTip')">
                    <option value="Todos">Tipo de Plato</option>
                    <option value="Entrante">Entrante</option><option value="Plato Principal">Plato Principal</option>
                    <option value="Postre">Postre</option>
                </select>
            </div>
            <div class="seccion-lateral">
                <h3>‚≠ê Favoritos</h3>
                <div id="lista-favs" class="lista-favs"></div>
                <button onclick="renderizar()" style="background:#ecf0f1; color:#7f8c8d; font-size:0.75em; margin-top:10px; padding:5px; width:100%; border:1px solid #ddd;">Mostrar todas</button>
            </div>
            <div class="seccion-lateral">
                <h3>üìù Bloc de Notas</h3>
                <textarea id="bloc-notas" placeholder="Escribe notas aqu√≠..."></textarea>
                <button onclick="limpiarNotas()" style="background:#bdc3c7; font-size:0.7em; margin-top:5px; padding:5px; width:100%;">Borrar Notas</button>
            </div>
        </div>
    </aside>

    <main class="contenido">
        <h1>El recetario de Mario y Esther üç≤</h1>
        <div class="formulario">
            <h3 id="tituloForm">Nueva Receta</h3>
            <input type="hidden" id="idDoc">
            <div class="fila"><input type="text" id="nombre" placeholder="Nombre de la receta"><input type="text" id="video" placeholder="Link del v√≠deo"></div>
            <div class="fila">
                <input type="file" id="foto" accept="image/*">
                <select id="ingrediente">
                    <option value="Pollo">Pollo</option><option value="Pulpo">Pulpo</option><option value="Pescado">Pescado</option>
                    <option value="Verduras">Verduras</option><option value="Legumbres">Legumbres</option><option value="Carne">Carne</option>
                </select>
            </div>
            <div class="fila">
                <select id="elaboracion"><option value="Horno">Horno</option><option value="Plancha">Plancha</option><option value="Airfryer">Airfryer</option><option value="Sart√©n">Sart√©n / Guiso</option></select>
                <select id="tipo"><option value="Entrante">Entrante</option><option value="Plato Principal">Plato Principal</option><option value="Postre">Postre</option></select>
            </div>
            <button onclick="enviarDatos()" id="btnAccion" style="width: 100%;">Guardar Receta</button>
            <button onclick="limpiarFormulario()" id="btnCan" style="display:none; width: 100%; background:#95a5a6; margin-top:10px;">Cancelar Edici√≥n</button>
        </div>
        <div class="filtros-seccion">
            <div class="fila">
                <select id="fIng" onchange="sincronizarFiltros('fIng')"><option value="Todos">Todos los Ingredientes</option><option value="Pollo">Pollo</option><option value="Carne">Carne</option></select>
                <select id="fEla" onchange="sincronizarFiltros('fEla')"><option value="Todas">Todas las Elaboraciones</option><option value="Horno">Horno</option></select>
                <select id="fTip" onchange="sincronizarFiltros('fTip')"><option value="Todos">Todos los Platos</option><option value="Entrante">Entrante</option></select>
            </div>
        </div>
        <div class="galeria" id="listaRecetas"></div>
    </main>
</div>

<button id="chat-btn-open" onclick="toggleChat()">üë®‚Äçüç≥</button>
<div id="chat-container">
    <div id="chat-header">
        <span>üë®‚Äçüç≥ Chef Experto</span>
        <span onclick="toggleChat()" style="cursor:pointer; font-size: 28px;">&times;</span>
    </div>
    <div id="chat-messages"></div>
    <div style="display: flex; border-top: 1px solid #eee; padding: 15px; background: #f9f9f9;">
        <input type="text" id="chat-input" placeholder="Pregunta algo..." style="flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
        <button onclick="preguntarChef()" style="padding: 10px 20px; margin-left: 10px; background: #27ae60; color: white; border: none; border-radius: 8px;">Enviar</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA4kvu1bj--OtEgQ2Z6-ia34Gk249tPdQc",
        authDomain: "el-recetario-de-mario-y-esther.firebaseapp.com",
        projectId: "el-recetario-de-mario-y-esther",
        storageBucket: "el-recetario-de-mario-y-esther.firebasestorage.app",
        messagingSenderId: "1070923399824",
        appId: "1:1070923399824:web:6763c4841887cc000c4e15"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let recetasLocales = [];

    db.collection("recetas").orderBy("fecha", "desc").onSnapshot((snapshot) => {
        recetasLocales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderizar();
    });

    function renderizar(idEspecifico = null) {
    const caja = document.getElementById('listaRecetas');
    const fi = document.getElementById('fIng').value;
    const fe = document.getElementById('fEla').value;
    const ft = document.getElementById('fTip').value;
    caja.innerHTML = '';

    recetasLocales.forEach(r => {
        if (idEspecifico ? String(r.id) === String(idEspecifico) : (fi === 'Todos' || r.ingrediente === fi) && (fe === 'Todas' || r.elaboracion === fe) && (ft === 'Todos' || r.tipo === ft)) {
            const esFav = r.esFavorito === true; 
            
            // Aqu√≠ est√° la construcci√≥n de la tarjeta
            caja.innerHTML += `
                <div class="tarjeta" id="receta-${r.id}">
                    <button class="fav-btn" onclick="toggleFav('${r.id}')">${esFav ? '‚ù§Ô∏è' : 'ü§ç'}</button>
                    <img src="${r.imagen || 'https://via.placeholder.com/300'}">
                    <div class="info">
                        <h3 style="margin:0;">${r.nombre}</h3>
                        <span class="tag tag-ing">${r.ingrediente}</span>
                        <span class="tag tag-ela">${r.elaboracion}</span>
                        <span class="tag tag-tip">${r.tipo}</span>
                        
                        ${r.video ? `<br><a href="${r.video}" target="_blank" style="color:#2980b9; font-size:0.85em; text-decoration:none; font-weight:bold; display:block; margin-top:10px;">üé¨ Ver V√≠deo Original</a>` : ''}
                        
                        <button onclick="consultarReceta('${r.id}')" style="margin-top:12px; width:100%; background:#27ae60; font-size:0.85em; padding:10px; border-radius:6px; border:none; color:white; cursor:pointer; font-weight:bold;">Preguntar al Chef üë®‚Äçüç≥</button>
                        
                        <button onclick="compartirWhatsApp('${r.id}')" style="margin-top:8px; width:100%; background:#25D366; font-size:0.85em; padding:10px; border-radius:6px; border:none; color:white; cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:8px;">
                            Enviar por WhatsApp üì±
                        </button>
                    </div>
                    <div class="acciones">
                        <button class="edit" onclick="prepararEdicion('${r.id}')">Editar</button>
                        <button class="del" onclick="borrarReceta('${r.id}')">Borrar</button>
                    </div>
                </div>`;
        }
    });
    actualizarSidebarFavs();
}

    async function toggleFav(id) {
        const receta = recetasLocales.find(r => r.id === id);
        if (receta) await db.collection("recetas").doc(id).update({ esFavorito: !receta.esFavorito });
    }

    function actualizarSidebarFavs() {
        const div = document.getElementById('lista-favs');
        div.innerHTML = '';
        const recFavs = recetasLocales.filter(r => r.esFavorito === true);
        if (recFavs.length === 0) { div.innerHTML = '<p style="color:#999; font-size:0.8em;">No hay favoritos.</p>'; return; }
        recFavs.forEach(r => div.innerHTML += `<div class="item-fav" onclick="verRecetaFav('${r.id}')">üìå ${r.nombre}</div>`);
    }

    function toggleChat() {
        const chat = document.getElementById('chat-container');
        const btnOpen = document.getElementById('chat-btn-open');
        const messages = document.getElementById('chat-messages');
        if (chat.style.display === 'flex') {
            chat.style.display = 'none';
            btnOpen.style.display = 'flex';
            messages.innerHTML = ''; 
        } else {
            chat.style.display = 'flex';
            btnOpen.style.display = 'none';
        }
    }

    function consultarReceta(id) {
    const r = recetasLocales.find(rec => rec.id === id);
    if (!r) return;
    
    const chat = document.getElementById('chat-container');
    const btnOpen = document.getElementById('chat-btn-open');
    const box = document.getElementById('chat-messages');
    
    box.innerHTML = ''; 
    chat.style.display = 'flex';
    btnOpen.style.display = 'none';
    
    box.innerHTML += `<div class="msg user-msg">Chef, ens√©√±ame a cocinar paso a paso: **${r.nombre}**</div>`;

    setTimeout(() => {
        // L√≥gica t√©cnica detallada seg√∫n el m√©todo
        let guiaTecnica = "";
        let tiempo = "";

        if(r.elaboracion === "Horno") {
            tiempo = "45 a 60 minutos";
            guiaTecnica = `Debemos precalentar a 200¬∞C. Es vital que el <strong>${r.ingrediente}</strong> entre seco para que la reacci√≥n de Maillard haga su magia y dore la superficie. Col√≥calo en la zona media y, si ves que se tuesta demasiado, cubre con papel de aluminio a mitad del proceso.`;
        } else if(r.elaboracion === "Airfryer") {
            tiempo = "15 a 22 minutos";
            guiaTecnica = `El secreto aqu√≠ es no saturar el cestillo. Pulveriza un poco de aceite sobre el <strong>${r.ingrediente}</strong> para que el aire caliente circule uniformemente. A mitad de tiempo, agita con energ√≠a para que el dorado sea homog√©neo por todas las caras.`;
        } else if(r.elaboracion === "Plancha") {
            tiempo = "10 a 15 minutos";
            guiaTecnica = `La plancha debe estar humeante. Sella el <strong>${r.ingrediente}</strong> a fuego fuerte para atrapar los jugos y luego baja un poco el fuego para que el calor llegue al centro sin quemar el exterior. No le des vueltas constantes; deja que se forme costra.`;
        } else {
            tiempo = "30 minutos";
            guiaTecnica = `Cocinaremos a fuego medio-bajo. Deja que el <strong>${r.ingrediente}</strong> se impregne de los sabores del sofrito o la salsa. Es un proceso de mimo donde el tiempo y el chup-chup son tus mejores aliados.`;
        }

        const respuestaChef = `
            <strong>üë®‚Äçüç≥ BIENVENIDO A LA COCINA: ${r.nombre}</strong><br><br>
            
            Vamos a tratar este <strong>${r.ingrediente}</strong> como se merece. Para este plato de tipo <em>${r.tipo}</em>, seguiremos un proceso meticuloso:<br><br>

            üî™ <strong>1. Preparaci√≥n Previa (Mise en Place):</strong><br>
            Antes de encender el fuego, limpia y corta el ingrediente principal en piezas de tama√±o similar; esto garantiza que todo se cocine al mismo tiempo. Salpimenta ahora, para que los sabores penetren en la fibra mientras preparas el equipo.<br><br>

            üî• <strong>2. El Proceso de Elaboraci√≥n (${r.elaboracion}):</strong><br>
            ${guiaTecnica} Durante estos <strong>${tiempo}</strong>, mantente atento a los cambios de color y aroma. La cocina es intuici√≥n, pero la t√©cnica de <em>${r.elaboracion}</em> requiere precisi√≥n.<br><br>

            ‚ú® <strong>3. Reposo y Acabado:</strong><br>
            Una vez fuera del fuego, no cortes ni sirvas inmediatamente. Deja que repose 2 o 3 minutos; esto hace que los jugos internos se redistribuyan. Termina con un chorrito de aceite de oliva virgen extra en crudo o unas escamas de sal para potenciar la textura.<br><br>

            üçé <strong>Valores Nutricionales Aproximados:</strong><br>
            ‚Ä¢ Calor√≠as: 350-550 kcal (dependiendo del aceite usado).<br>
            ‚Ä¢ Perfil: Alto en prote√≠nas por el ${r.ingrediente} y bajo en az√∫cares.<br><br>

            üöÄ <strong>Aprende visualmente:</strong><br>
            ‚Ä¢ <a href="https://www.youtube.com/results?search_query=tecnica+profesional+${r.nombre}" target="_blank">Masterclass en YouTube</a><br>
            ‚Ä¢ <a href="https://www.tiktok.com/search?q=receta+${r.nombre}+paso+a+paso" target="_blank">Trucos r√°pidos en TikTok</a>
        `;
        
        box.innerHTML += `<div class="msg bot-msg">${respuestaChef}</div>`;
        box.scrollTop = box.scrollHeight;
    }, 800);
}

    async function preguntarChef() {
    const input = document.getElementById('chat-input');
    const consulta = input.value.trim();
    if(!consulta) return;
    
    const box = document.getElementById('chat-messages');
    box.innerHTML += `<div class="msg user-msg">Chef, b√∫scame la receta completa de: **${consulta}**</div>`;
    input.value = '';
    box.scrollTop = box.scrollHeight;

    // Efecto de b√∫squeda profunda
    const typingId = "typing-" + Date.now();
    box.innerHTML += `<div class="msg bot-msg" id="${typingId}">üë®‚Äçüç≥ Buscando ingredientes, tiempos y t√©cnicas para "${consulta}"...</div>`;
    
    setTimeout(() => {
        const typingElem = document.getElementById(typingId);
        if(typingElem) typingElem.remove();

        // Estructura de Receta Completa Profesional
        const respuestaChef = `
            <h2 style="color:#d35400; margin-top:0;">üìñ Receta Maestra: ${consulta}</h2>
            
            <div style="background:#fef9e7; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9em;">
                ‚è±Ô∏è <strong>Preparaci√≥n:</strong> 15 min | üç≥ <strong>Cocci√≥n:</strong> 25-30 min | üë• <strong>Raciones:</strong> 2 personas
            </div>

            <h3>üõí Ingredientes y Cantidades</h3>
            <ul style="padding-left:20px;">
                <li><strong>Prote√≠na/Base:</strong> 400g de ${consulta}</li>
                <li><strong>Vegetales:</strong> 1 cebolla peque√±a, 2 dientes de ajo, 1 pimiento.</li>
                <li><strong>L√≠quidos:</strong> 50ml de vino blanco o caldo, 2 cucharadas de AOVE.</li>
                <li><strong>Especias:</strong> Sal fina, pimienta negra reci√©n molida, una pizca de piment√≥n o hierbas provenzales.</li>
            </ul>

            <h3>üë®‚Äçüç≥ Elaboraci√≥n Detallada</h3>
            <p><strong>Paso 1 (Mise en place):</strong> Corta todos los vegetales en <em>brunoise</em> (dados muy peque√±os) y limpia bien el ingrediente principal. Seca la prote√≠na con papel de cocina para asegurar un buen sellado.</p>
            
            <p><strong>Paso 2 (El sofrito):</strong> En una sart√©n amplia con el AOVE caliente, a√±ade la cebolla y el pimiento. Cocina a fuego medio hasta que la cebolla est√© trasl√∫cida (unos 8 min). A√±ade el ajo al final para que no se queme.</p>
            
            <p><strong>Paso 3 (Cocci√≥n principal):</strong> Sube el fuego y a√±ade el <strong>${consulta}</strong>. Sella por ambos lados hasta que est√© dorado. Desglasa con el vino blanco rascando el fondo para recuperar los jugos caramelizados.</p>
            
            <p><strong>Paso 4 (Punto final):</strong> Baja el fuego y deja que reduzca el l√≠quido. Si es carne, busca el punto deseado; si es verdura, que quede <em>al dente</em>.</p>

            <h3>üçΩÔ∏è Emplatado y Presentaci√≥n</h3>
            <p>Sirve en un plato llano grande. Coloca la guarnici√≥n de base y la pieza principal encima. Decora con un hilo de aceite de oliva virgen extra y una rama de perejil fresco o cebollino picado para dar altura y color.</p>

            <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">

            üçé <strong>An√°lisis Nutricional (Estimado):</strong><br>
            ‚Ä¢ <strong>Kcal:</strong> 420 | <strong>Prote√≠na:</strong> 30g | <strong>Grasas:</strong> 15g | <strong>HC:</strong> 10g<br><br>

            üí° <strong>Consejo de Mejora:</strong> Si quieres un sabor m√°s profundo, a√±ade una nuez de mantequilla fr√≠a justo al terminar la cocci√≥n y remueve para emulsionar la salsa.

            <br><br>
            üöÄ <strong>Gu√≠as Multimedia:</strong><br>
            <a href="https://www.youtube.com/results?search_query=receta+completa+${consulta}" target="_blank">üé¨ YouTube</a> | 
            <a href="https://www.tiktok.com/search?q=receta+${consulta}" target="_blank">üì± TikTok</a> | 
            <a href="https://www.instagram.com/explore/tags/${consulta.replace(/\s+/g, '')}recipe" target="_blank">üì∏ Instagram</a>
        `;
        
        box.innerHTML += `<div class="msg bot-msg">${respuestaChef}</div>`;
        box.scrollTop = box.scrollHeight;
    }, 2000);
}

    function toggleSidebar() { const s = document.querySelector('.sidebar'); s.classList.toggle('active'); }
    function sincronizarFiltros(id) { 
        const val = document.getElementById(id).value; 
        const tipo = id.substring(1); 
        document.getElementById('f'+tipo).value = val; 
        document.getElementById('s'+tipo).value = val; 
        renderizar(); 
    }
    function verRecetaFav(id) { renderizar(id); toggleSidebar(); }
    function prepararEdicion(id) {
        const r = recetasLocales.find(rec => rec.id === id);
        document.getElementById('idDoc').value = r.id;
        document.getElementById('nombre').value = r.nombre;
        document.getElementById('video').value = r.video || '';
        document.getElementById('btnCan').style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    async function enviarDatos() {
        const id = document.getElementById('idDoc').value;
        const nombre = document.getElementById('nombre').value;
        const archivo = document.getElementById('foto').files[0];
        if(!nombre) return alert("Nombre obligatorio");
        let imgFinal = recetasLocales.find(r => r.id === id)?.imagen || "https://via.placeholder.com/300";
        if(archivo) {
            const reader = new FileReader();
            imgFinal = await new Promise(res => {
                reader.onload = () => res(reader.result);
                reader.readAsDataURL(archivo);
            });
        }
        const datos = {
            nombre, video: document.getElementById('video').value,
            ingrediente: document.getElementById('ingrediente').value,
            elaboracion: document.getElementById('elaboracion').value,
            tipo: document.getElementById('tipo').value,
            imagen: imgFinal, fecha: new Date()
        };
        id ? await db.collection("recetas").doc(id).update(datos) : await db.collection("recetas").add(datos);
        limpiarFormulario();
    }
    
    function limpiarFormulario() { 
        document.getElementById('idDoc').value = ''; 
        document.getElementById('nombre').value = ''; 
        document.getElementById('video').value = '';
        document.getElementById('btnCan').style.display = "none"; 
    }
    function borrarReceta(id) { if(confirm("¬øBorrar?")) db.collection("recetas").doc(id).delete(); }
    const bloc = document.getElementById('bloc-notas');
    bloc.value = localStorage.getItem('user_notas') || '';
    bloc.addEventListener('input', () => localStorage.setItem('user_notas', bloc.value));
    
    function compartirWhatsApp(id) {
    const r = recetasLocales.find(rec => rec.id === id);
    if (!r) return;

    const texto = `*¬°Mira esta receta de nuestro recetario!* üç≤%0A%0A` +
                  `*Plato:* ${r.nombre}%0A` +
                  `*Ingrediente:* ${r.ingrediente}%0A` +
                  `*T√©cnica:* ${r.elaboracion}%0A` +
                  `*Tipo:* ${r.tipo}%0A%0A` +
                  (r.video ? `üé¨ *V√≠deo:* ${r.video}%0A%0A` : '') +
                  `üëâ *Ver receta completa:* https://www.youtube.com/results?search_query=receta+${r.nombre.split(' ').join('+')}`;

    window.open(`https://api.whatsapp.com/send?text=${texto}`, '_blank');
}
</script>
</body>
</html>
